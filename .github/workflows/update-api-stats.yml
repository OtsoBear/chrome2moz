name: Update API Coverage Stats

on:
  schedule:
    - cron: '0 0 * * 1'  # Weekly on Mondays at 00:00 UTC
  workflow_dispatch:
  push:
    branches: [main]
    paths:
      - 'src/parser/javascript.rs'
      - 'src/transformer/**'
      - 'src/scripts/fetch_chrome_only_apis.rs'

jobs:
  update-stats:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        
      - name: Setup Rust
        uses: actions-rust-lang/setup-rust-toolchain@v1
        with:
          toolchain: stable
          
      - name: Build project
        run: cargo build --release --features cli
        
      - name: Run stats update script
        id: update_stats
        run: |
          chmod +x .github/scripts/update-stats.sh
          .github/scripts/update-stats.sh
          
      - name: Check for changes
        id: check_changes
        run: |
          if git diff --quiet; then
            echo "has_changes=false" >> $GITHUB_OUTPUT
            echo "No changes detected"
          else
            echo "has_changes=true" >> $GITHUB_OUTPUT
            echo "Changes detected"
          fi
          
      - name: Commit and push
        if: steps.check_changes.outputs.has_changes == 'true'
        run: |
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"
          git add README.md CHROME_ONLY_API_IMPLEMENTATION_STATUS.md
          git commit -m "chore: update Chrome API coverage stats [skip ci]" \
            -m "Total: ${{ steps.update_stats.outputs.total }}" \
            -m "Implemented: ${{ steps.update_stats.outputs.implemented }} (${{ steps.update_stats.outputs.percentage }}%)" \
            -m "Auto-updated by GitHub Actions"
          git push
          
      - name: Create job summary
        if: always()
        run: |
          if [[ "${{ steps.check_changes.outputs.has_changes }}" == "true" ]]; then
            cat >> $GITHUB_STEP_SUMMARY << EOF
          ## ðŸ“Š Chrome API Coverage Update
          
          ![Progress](https://progress-bar.xyz/${{ steps.update_stats.outputs.percentage }}/?scale=100&title=Coverage&width=400&color=00d1b2&suffix=%25)
          
          | Metric | Value |
          |--------|-------|
          | **Total APIs** | ${{ steps.update_stats.outputs.total }} |
          | **Implemented** | ${{ steps.update_stats.outputs.implemented }} (${{ steps.update_stats.outputs.percentage }}%) |
          | **Not Implemented** | ${{ steps.update_stats.outputs.not_implemented }} |
          
          âœ… Stats updated and committed successfully
          
          Updated: $(date -u '+%Y-%m-%d %H:%M:%S UTC')
          EOF
          else
            cat >> $GITHUB_STEP_SUMMARY << EOF
          ## ðŸ“Š Chrome API Coverage Check
          
          No changes detected - stats are already up to date.
          
          Checked: $(date -u '+%Y-%m-%d %H:%M:%S UTC')
          EOF
          fi